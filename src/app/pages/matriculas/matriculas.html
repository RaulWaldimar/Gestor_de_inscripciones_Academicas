<div class="matriculas-container">
  <div class="header">
    <h1>Gestión de Matrículas</h1>
    <button *ngIf="!showForm" class="btn btn-primary" (click)="showForm = true">
      + Nueva Matrícula
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="alert alert-info">
    <span class="spinner"></span> Cargando matrículas...
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Formulario -->
  <div *ngIf="showForm" class="form-modal">
    <div class="form-card">
      <h2>Nueva Matrícula</h2>
      <form [formGroup]="matriculaForm" (ngSubmit)="guardarMatricula()">
        <div class="form-group">
          <label>Estudiante *</label>
          <select formControlName="estudianteId">
            <option value="">-- Seleccionar estudiante --</option>
            <option *ngFor="let est of estudiantes" [value]="est.id!">
              {{ est.nombres }} {{ est.apellidos }}
            </option>
          </select>
          <span *ngIf="matriculaForm.get('estudianteId')?.invalid && matriculaForm.get('estudianteId')?.touched" class="error">
            Debe seleccionar un estudiante
          </span>
        </div>
        <div class="form-group">
          <label>Curso *</label>
          <select formControlName="cursoId">
            <option value="">-- Seleccionar curso --</option>
            <option *ngFor="let curso of cursos" [value]="curso.id">
              {{ curso.nombre }} - Grado {{ curso.grado }} Sec {{ curso.seccion }}
            </option>
          </select>
          <span *ngIf="matriculaForm.get('cursoId')?.invalid && matriculaForm.get('cursoId')?.touched" class="error">
            Debe seleccionar un curso
          </span>
        </div>
        <div class="form-group">
          <label>Estado *</label>
          <select formControlName="estado">
            <option value="activa">Activa</option>
            <option value="completada">Completada</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-success" [disabled]="matriculaForm.invalid">
            Crear Matrícula
          </button>
          <button type="button" class="btn btn-secondary" (click)="resetForm()">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de Matrículas -->
  <div *ngIf="!showForm && !loading && !error" class="matriculas-section">
    <div class="filters">
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por estudiante o curso..."
        [(ngModel)]="buscador"
      />
      <select [(ngModel)]="filtroEstado" class="filter-select">
        <option value="">-- Todos los estados --</option>
        <option value="activa">Activa</option>
        <option value="completada">Completada</option>
        <option value="cancelada">Cancelada</option>
      </select>
    </div>

    <div *ngIf="matriculasFiltradas.length === 0" class="empty-state">
      <p>No hay matrículas disponibles</p>
    </div>

    <table *ngIf="matriculasFiltradas.length > 0" class="matriculas-table">
      <thead>
        <tr>
          <th>Estudiante</th>
          <th>Curso</th>
          <th>Fecha Inscripción</th>
          <th>Estado</th>
          <th>Calificación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let matricula of matriculasPaginadas">
          <td>{{ (matricula.nombreEstudiante || obtenerNombreEstudiante(matricula.estudianteId)) | titlecase }}</td>
          <td>{{ (matricula.nombreCurso || obtenerNombreCurso(matricula.cursoId)) | titlecase }}</td>
          <td>{{ matricula.fechaInscripcion | safeDate }}</td>
          <td>
            <span class="estado-badge" [ngClass]="'estado-' + matricula.estado">
              {{ matricula.estado | estadoMatricula }}
            </span>
          </td>
          <td>{{ matricula.calificacionFinal || 'Sin calificar' }}</td>
          <td class="acciones">
            <button 
              *ngIf="matricula.estado === 'activa' && matricula.id"
              class="btn btn-sm btn-delete" 
              (click)="cancelarMatricula(matricula.id!)">
              Cancelar
            </button>
            <button 
              *ngIf="matricula.estado === 'cancelada' && matricula.id"
              class="btn btn-sm btn-success" 
              (click)="revertirCancelacion(matricula.id!)">
              Reactivar
            </button>
            <button 
              *ngIf="matricula.id"
              class="btn btn-sm btn-danger" 
              (click)="eliminarMatricula(matricula.id!)">
              Eliminar
            </button>
            <span *ngIf="matricula.estado === 'completada'" class="text-muted">-</span>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Paginación -->
    <div *ngIf="totalPaginas > 1" class="pagination">
      <button class="btn btn-sm" (click)="paginaAnterior()" [disabled]="paginaActual === 1">
        ← Anterior
      </button>
      <span class="page-info">
        Página {{ paginaActual }} de {{ totalPaginas }} 
        ({{ matriculasFiltradas.length }} registros)
      </span>
      <button class="btn btn-sm" (click)="siguientePagina()" [disabled]="paginaActual === totalPaginas">
        Siguiente →
      </button>
    </div>
  </div>
</div>
