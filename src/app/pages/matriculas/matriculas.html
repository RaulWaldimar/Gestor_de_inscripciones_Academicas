<div class="matriculas-container">
  <div class="header">
    <h1>Gesti√≥n de Matr√≠culas</h1>
    <button *ngIf="!showForm" class="btn btn-primary" (click)="showForm = true">
      + Nueva Matr√≠cula
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="alert alert-info">
    <span class="spinner"></span> Cargando matr√≠culas...
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Formulario -->
  <div *ngIf="showForm" class="form-modal">
    <div class="form-card">
      <h2>Nueva Matr√≠cula</h2>
      <form [formGroup]="matriculaForm" (ngSubmit)="guardarMatricula()">
        <div class="form-group">
          <label>Estudiante *</label>
          <select formControlName="estudianteId">
            <option value="">-- Seleccionar estudiante --</option>
            <option *ngFor="let est of estudiantes" [value]="est.id!">
              {{ est.nombres }} {{ est.apellidos }} (Grado {{ est.grado }} - Sec {{ est.seccion }})
            </option>
          </select>
          <span *ngIf="matriculaForm.get('estudianteId')?.invalid && matriculaForm.get('estudianteId')?.touched" class="error">
            Debe seleccionar un estudiante
          </span>
        </div>

        <!-- Informaci√≥n del estudiante seleccionado -->
        <div *ngIf="estudianteSeleccionado" class="info-box">
          <strong>Estudiante seleccionado:</strong> {{ estudianteSeleccionado.nombres }} {{ estudianteSeleccionado.apellidos }}
          <br>
          <strong>Grado - Secci√≥n:</strong> {{ estudianteSeleccionado.grado }} - {{ estudianteSeleccionado.seccion }}
        </div>

        <div class="form-group">
          <label>Curso *</label>
          <select formControlName="cursoId">
            <option value="">-- Seleccionar curso --</option>
            <option *ngFor="let curso of cursosDisponibles" [value]="curso.id">
              {{ curso.nombre }} - Grado {{ curso.grado }} Sec {{ curso.seccion }}
            </option>
          </select>
          <span *ngIf="matriculaForm.get('cursoId')?.invalid && matriculaForm.get('cursoId')?.touched" class="error">
            Debe seleccionar un curso
          </span>
          <span *ngIf="estudianteSeleccionado && cursosDisponibles.length === 0" class="error">
            No hay cursos disponibles para este estudiante
          </span>
        </div>
        <div class="form-group">
          <label>Estado *</label>
          <select formControlName="estado">
            <option value="activa">Activa</option>
            <option value="completada">Completada</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-success" [disabled]="matriculaForm.invalid">
            Crear Matr√≠cula
          </button>
          <button type="button" class="btn btn-secondary" (click)="resetForm()">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de Matr√≠culas -->
  <div *ngIf="!showForm && !loading && !error" class="matriculas-section">
    <!-- Tabs de Vista -->
    <div class="view-tabs">
      <button 
        class="tab-button" 
        [class.active]="vistaActual === 'general'"
        (click)="vistaActual = 'general'">
        üìä Vista General
      </button>
      <button 
        class="tab-button" 
        [class.active]="vistaActual === 'grados'"
        (click)="vistaActual = 'grados'">
        üéì Por Grados
      </button>
    </div>

    <div class="filters">
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por estudiante o curso..."
        [(ngModel)]="buscador"
      />
      <select [(ngModel)]="filtroEstado" class="filter-select">
        <option value="">-- Todos los estados --</option>
        <option value="activa">Activa</option>
        <option value="completada">Completada</option>
        <option value="cancelada">Cancelada</option>
      </select>
    </div>

    <div *ngIf="matriculasFiltradas.length === 0" class="empty-state">
      <p>No hay matr√≠culas disponibles</p>
    </div>

    <!-- VISTA GENERAL -->
    <div *ngIf="vistaActual === 'general' && matriculasFiltradas.length > 0" class="vista-general">
      <table class="matriculas-table">
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Grado</th>
            <th>Curso</th>
            <th>Fecha Inscripci√≥n</th>
            <th>Estado</th>
            <th>Calificaci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let matricula of matriculasFiltradas">
            <td>{{ (matricula.nombreEstudiante || obtenerNombreEstudiante(matricula.estudianteId)) | titlecase }}</td>
            <td>
              <span class="grado-badge">{{ obtenerGradoEstudiante(matricula.estudianteId) }}</span>
            </td>
            <td>{{ (matricula.nombreCurso || obtenerNombreCurso(matricula.cursoId)) | titlecase }}</td>
            <td>{{ matricula.fechaInscripcion | safeDate }}</td>
            <td>
              <span class="estado-badge" [ngClass]="'estado-' + matricula.estado">
                {{ matricula.estado | estadoMatricula }}
              </span>
            </td>
            <td>{{ matricula.calificacionFinal || 'Sin calificar' }}</td>
            <td class="acciones">
              <button 
                *ngIf="matricula.estado === 'activa' && matricula.id"
                class="btn btn-sm btn-delete" 
                (click)="cancelarMatricula(matricula.id!)">
                Cancelar
              </button>
              <button 
                *ngIf="matricula.estado === 'cancelada' && matricula.id"
                class="btn btn-sm btn-success" 
                (click)="revertirCancelacion(matricula.id!)">
                Reactivar
              </button>
              <button 
                *ngIf="matricula.id"
                class="btn btn-sm btn-danger" 
                (click)="eliminarMatricula(matricula.id!)">
                Eliminar
              </button>
              <span *ngIf="matricula.estado === 'completada'" class="text-muted">-</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- VISTA POR GRADOS -->
    <div *ngIf="vistaActual === 'grados' && matriculasFiltradas.length > 0" class="vista-grados">
      <div *ngFor="let grado of gradosUnicos" class="grado-section">
        <div class="grado-header-card">
          <h3>üìö GRADO {{ grado }}</h3>
          <span class="grado-count">{{ obtenerMatriculasPorGrado(grado).length }} matr√≠culas</span>
        </div>
        
        <table class="matriculas-table">
          <thead>
            <tr>
              <th>Estudiante</th>
              <th>Secci√≥n</th>
              <th>Curso</th>
              <th>Fecha Inscripci√≥n</th>
              <th>Estado</th>
              <th>Calificaci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let matricula of obtenerMatriculasPorGrado(grado)">
              <td><strong>{{ (matricula.nombreEstudiante || obtenerNombreEstudiante(matricula.estudianteId)) | titlecase }}</strong></td>
              <td>
                <span class="seccion-badge">{{ obtenerSeccionEstudiante(matricula.estudianteId) }}</span>
              </td>
              <td>{{ (matricula.nombreCurso || obtenerNombreCurso(matricula.cursoId)) | titlecase }}</td>
              <td>{{ matricula.fechaInscripcion | safeDate }}</td>
              <td>
                <span class="estado-badge" [ngClass]="'estado-' + matricula.estado">
                  {{ matricula.estado | estadoMatricula }}
                </span>
              </td>
              <td>{{ matricula.calificacionFinal || 'Sin calificar' }}</td>
              <td class="acciones">
                <button 
                  *ngIf="matricula.estado === 'activa' && matricula.id"
                  class="btn btn-sm btn-delete" 
                  (click)="cancelarMatricula(matricula.id!)">
                  Cancelar
                </button>
                <button 
                  *ngIf="matricula.estado === 'cancelada' && matricula.id"
                  class="btn btn-sm btn-success" 
                  (click)="revertirCancelacion(matricula.id!)">
                  Reactivar
                </button>
                <button 
                  *ngIf="matricula.id"
                  class="btn btn-sm btn-danger" 
                  (click)="eliminarMatricula(matricula.id!)">
                  Eliminar
                </button>
                <span *ngIf="matricula.estado === 'completada'" class="text-muted">-</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Paginaci√≥n -->
    <div *ngIf="totalPaginas > 1" class="pagination">
      <button class="btn btn-sm" (click)="paginaAnterior()" [disabled]="paginaActual === 1">
        ‚Üê Anterior
      </button>
      <span class="page-info">
        P√°gina {{ paginaActual }} de {{ totalPaginas }} 
        ({{ matriculasFiltradas.length }} registros)
      </span>
      <button class="btn btn-sm" (click)="siguientePagina()" [disabled]="paginaActual === totalPaginas">
        Siguiente ‚Üí
      </button>
    </div>
  </div>
</div>

